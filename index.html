<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับเครื่องมือแพทย์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
      <!-- Favicon / App Icons (ไฟล์อยู่โฟลเดอร์เดียวกับ index.html) -->
      <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
      <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
      <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
      <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
      <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
      <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
      <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
    
      <link rel="icon" type="image/png" sizes="192x192" href="android-icon-192x192.png">
      <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
      <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    
      <!-- PWA Manifest -->
      <link rel="manifest" href="manifest.json">
    
      <!-- Windows tiles -->
      <meta name="msapplication-TileColor" content="#ffffff">
      <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
    
      <!-- Theme color (Android/desktop browser UI) -->
      <meta name="theme-color" content="#ffffff">
    
      <!-- iOS PWA look (ทางเลือก) -->
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-backdrop { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- ===== Header: โลโก้ + ชื่อระบบ (พื้นหลังใช้ .gradient-bg ที่คุณประกาศไว้) ===== -->
  <header class="gradient-bg text-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8">
      <!-- วงกลมโลโก้ -->
      <div class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full bg-white/10 ring-2 ring-white/30
                  flex items-center justify-center overflow-hidden">
        <!-- เปลี่ยน src ให้เป็นไฟล์โลโก้จริงของ รพ. (วางไฟล์ไว้โฟลเดอร์เดียวกับ index) -->
        <img src="hospital-logo.png" alt="โลโก้โรงพยาบาล" class="w-16 h-16 sm:w-20 sm:h-20 object-contain" />
      </div>

      <!-- ข้อความหัวเรื่อง (กึ่งกลางอัตโนมัติทุกอุปกรณ์) -->
      <h1 class="text-center font-semibold mt-4 text-2xl sm:text-3xl">
        ระบบรับเครื่องมือแพทย์
      </h1>
      <p class="text-center text-white/90 mt-1 text-sm sm:text-base">
        โรงพยาบาลภูมิพลอดุลยเดช พอ.
      </p>
    </div>
  </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Form Section -->
        <div class="bg-white rounded-xl card-shadow p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-plus-circle text-blue-600 text-2xl mr-3"></i>
                <h2 class="text-xl font-semibold text-gray-800">เพิ่มข้อมูลเครื่องมือผ่าตัด</h2>
            </div>

            <form id="medicalToolForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Company Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building mr-2"></i>ชื่อบริษัท
                        </label>
                        <input type="text" id="companyName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                   
                    <!-- Tool Type -->
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tools mr-2"></i>ประเภทเครื่องมือ
                      </label>
                      <select id="toolTypeSelect" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- เลือกประเภท --</option>
                        <option value="Plate and Screw">Plate and Screw</option>
                        <option value="Nail">Nail</option>
                        <option value="เครื่องมือผ่าตัดเปลี่ยนข้อเข่า/ข้อสะโพก">เครื่องมือผ่าตัดเปลี่ยนข้อเข่า/ข้อสะโพก</option>
                        <option value="เครื่องมือ Scope">เครื่องมือ Scope</option>
                        <option value="เอกสาร">เอกสาร</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                      </select>
                      <input type="text" id="toolTypeOther" placeholder="ระบุประเภทเครื่องมือ"
                             class="mt-2 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent hidden">
                    </div>


                    <!-- Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-hashtag mr-2"></i>จำนวน
                        </label>
                        <input type="number" id="quantity" required min="1"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Sterile Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-shield-alt mr-2"></i>สถานะเครื่องมือ
                        </label>
                        <select id="sterileStatus" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">เลือกสถานะ</option>
                            <option value="ต้องทำ Sterile">ต้องทำ Sterile</option>
                            <option value="ต้องทำ Sterile">ไม่ต้องทำ Sterile</option>
                            <option value="Sterile มาแล้ว">Sterile มาแล้ว</option>
                        </select>
                    </div>

                    <!-- Surgeon -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-md mr-2"></i>แพทย์ผ่าตัด
                        </label>
                        <input type="text" id="surgeon" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Surgery Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-2"></i>วันที่ผ่าตัด
                        </label>
                        <input type="date" id="surgeryDate" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Receive DateTime -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-2"></i>วันที่และเวลารับเครื่องมือ
                        </label>
                        <input type="datetime-local" id="receiveDateTime" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-camera mr-2"></i>อัพโหลดรูปภาพเครื่องมือ
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                        <input type="file" id="toolImage" accept="image/*" class="hidden">
                        <div id="imagePreview" class="hidden mb-4">
                            <img id="previewImg" class="mx-auto max-h-32 rounded-lg">
                        </div>
                        <button type="button" onclick="document.getElementById('toolImage').click()" 
                                class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-upload mr-2"></i>เลือกรูปภาพ
                        </button>
                        <p class="text-sm text-gray-500 mt-2">รองรับไฟล์ JPG, PNG</p>
                    </div>
                </div>
                
                <!-- Buttons: เพิ่มชุดในคิว + ล้างเฉพาะชุดนี้ -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                  <button type="button" id="btnAddSet"
                          class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    <i class="fas fa-layer-group mr-2"></i>กดตรงนี้เพื่อตรวจสอบก่อนการบันทึก
                  </button>
                  <button type="button" id="btnResetCurrent"
                          class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    <i class="fas fa-redo mr-2"></i>ล้างฟอร์มชุดนี้
                  </button>
                </div>
            </form>
        </div>
<!-- Pending queue (ชุดที่เตรียมบันทึก) -->
<div class="bg-white rounded-xl card-shadow p-6 mt-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center">
      <i class="fas fa-list text-indigo-600 text-2xl mr-3"></i>
      <h3 class="text-lg font-semibold text-gray-800">ชุดเครื่องมือที่เตรียมบันทึก</h3>
    </div>
    <span id="pendingCount" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">0 ชุด</span>
  </div>

  <div id="pendingEmpty" class="text-gray-500 text-center py-6">
    ยังไม่มีชุดที่เตรียมบันทึก — กด “เพิ่มชุดเครื่องมือ” ด้านบนก่อน
  </div>

          <div id="pendingList" class="hidden overflow-x-auto">
            <table class="w-full table-auto">
              <thead class="bg-indigo-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">ลำดับ</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">บริษัท</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">เครื่องมือ</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">จำนวน</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">สถานะ</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">แพทย์</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">วันที่ผ่าตัด</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">รูป</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-700">ลบ</th>
                </tr>
              </thead>
              <tbody id="pendingBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        
          <!-- ผู้รับเครื่องมือ (ใส่ครั้งเดียว) -->
          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                <i class="fas fa-user mr-2"></i>ผู้รับเครื่องมือ (ใส่ครั้งเดียวสำหรับทุกชุด)
              </label>
              <input type="text" id="receiverFinal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
          </div>
        
          <div class="flex flex-col sm:flex-row gap-4 pt-6">
            <button type="button" id="btnSaveAll"
                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium">
              <i class="fas fa-save mr-2"></i>บันทึกทั้งหมด
            </button>
          </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl card-shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-table text-blue-600 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold text-gray-800">ข้อมูลเครื่องมือที่บันทึก</h2>
                </div>
                <span id="recordCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">0 รายการ</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-blue-50">
                      <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ลำดับ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">บริษัท</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">เครื่องมือ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">จำนวน</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">สถานะ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">แพทย์</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ผู้รับเครื่องมือ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">วันที่รับเครื่องมือ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">วันที่ผ่าตัด</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">รูปภาพ</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-200">
                        <tr id="noDataRow">
                            <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2 block"></i>
                                ยังไม่มีข้อมูล
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl max-h-full overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">รูปภาพเครื่องมือ</h3>
                <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <img id="modalImage" class="block mx-auto max-w-full max-h-[75vh] h-auto rounded-lg" alt="">
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold">แก้ไขข้อมูลเครื่องมือ</h3>
            </div>
            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="editIndex">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อบริษัท</label>
                        <input type="text" id="editCompanyName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทเครื่องมือ</label>
                      <select id="editToolTypeSelect" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">-- เลือกประเภท --</option>
                        <option value="Plate and Screw">Plate and Screw</option>
                        <option value="Nail">Nail</option>
                        <option value="เครื่องมือผ่าตัดเปลี่ยนข้อเข่า/ข้อสะโพก">เครื่องมือผ่าตัดเปลี่ยนข้อเข่า/ข้อสะโพก</option>
                        <option value="เครื่องมือ Scope">เครื่องมือ Scope</option>
                        <option value="เอกสาร">เอกสาร</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                      </select>
                      <input type="text" id="editToolTypeOther" placeholder="ระบุประเภทเครื่องมือ"
                             class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 hidden">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">จำนวน</label>
                        <input type="number" id="editQuantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">สถานะเครื่องมือ</label>
                        <select id="editSterileStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="ต้องทำ Sterile">ต้องทำ Sterile</option>
                            <option value="Sterile มาแล้ว">Sterile มาแล้ว</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">แพทย์ผ่าตัด</label>
                        <input type="text" id="editSurgeon" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ผ่าตัด</label>
                        <input type="date" id="editSurgeryDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- Edit: เปลี่ยนรูป (ไม่บังคับ) -->
                    <div class="grid grid-cols-1 gap-3 pt-2 md:col-span-2">
                      <label class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-camera mr-2"></i> เปลี่ยนรูปภาพ (ถ้าไม่เลือก จะใช้รูปเดิม)
                      </label>
                      <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="editImageInput" accept="image/*" class="hidden">
                        <div id="editImageCurrent" class="mb-2 text-sm text-gray-600"></div>
                        <div id="editImagePreview" class="hidden mb-2">
                          <img id="editPreviewImg" class="mx-auto max-h-36 rounded-lg" alt="">
                        </div>
                        <div class="flex gap-2 justify-center">
                          <button type="button"
                                  onclick="document.getElementById('editImageInput').click()"
                                  class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-md">เลือกรูปใหม่</button>
                          <button type="button" id="btnClearEditImage"
                                  class="bg-gray-100 text-gray-700 px-3 py-1.5 rounded-md">ล้างรูปใหม่</button>
                        </div>
                      </div>
                    </div>
                                        <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ผู้รับเครื่องมือ</label>
                        <input type="text" id="editReceiver" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>บันทึกการแก้ไข
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Saving Modal -->
    <div id="savingModal" class="fixed inset-0 hidden z-[10000]">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
          <div class="mx-auto mb-3 w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center">
            <svg class="animate-spin w-6 h-6 text-blue-600" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-800">กำลังบันทึกข้อมูล...</h3>
          <p class="text-sm text-gray-500 mt-1">โปรดรอสักครู่</p>
        </div>
      </div>
    </div>
    
    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 hidden z-[10001]">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
          <div id="resultIcon" class="mx-auto mb-3 w-12 h-12 rounded-full flex items-center justify-center"></div>
          <h3 id="resultTitle" class="text-lg font-semibold text-gray-800"></h3>
          <p id="resultText" class="text-sm text-gray-600 mt-1"></p>
          <button type="button" id="resultCloseBtn"
                  class="mt-5 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            ปิด
          </button>
        </div>
      </div>
    </div>

    
    <!-- Footer -->
    <footer class="gradient-bg text-white mt-16">
        <div class="container mx-auto px-4 py-6 text-center">
            <p class="text-blue-100">พัฒนาระบบโดย <br>พ.อ.อ.ธนกฤต วงศ์ศิลา<br> น.สันทัดงาน กวห.รพ.ภูมิพลอดุลยเดช พอ.</p>
        </div>
    </footer>

<script>
/* ==============================
   CONFIG & STATE
================================*/
const API_BASE = "https://script.google.com/macros/s/AKfycbzxLfUJIwFPEixuoERmew6L2g3mjRs6R0hAcdKRmDM9nibBVU7xbg4aVxKuuf37fO_y/exec";

let medicalTools = [];
let editingIndex = -1;
let currentPreviewDataURL = null;   // preview รูปตอนเพิ่มชุด
let editNewImageDataURL = null;     // preview รูปใหม่ตอนแก้ไข
let pendingSets = [];               // คิวชุดเครื่องมือที่จะบันทึกทีเดียว

/* ==============================
   TOAST (แจ้งเตือนสวย ๆ)
================================*/
function ensureToastRoot(){
  let root = document.getElementById('toastRoot');
  if (!root){
    root = document.createElement('div');
    root.id = 'toastRoot';
    root.className = 'fixed top-4 right-4 z-[9999] space-y-3 max-w-[90vw]';
    document.body.appendChild(root);
  }
  return root;
}

function notify(type='info', text='', {timeout=2800}={}){
  const root = ensureToastRoot();
  const map = {
    success: { icon: 'fa-circle-check', bar: 'bg-green-500', border: 'border-green-500', color: 'text-green-600' },
    error:   { icon: 'fa-triangle-exclamation', bar: 'bg-red-500',   border: 'border-red-500',   color: 'text-red-600' },
    warning: { icon: 'fa-circle-exclamation',   bar: 'bg-amber-500', border: 'border-amber-500', color: 'text-amber-600' },
    info:    { icon: 'fa-circle-info',          bar: 'bg-blue-500',  border: 'border-blue-500',  color: 'text-blue-600' },
  };
  const tone = map[type] || map.info;

  const el = document.createElement('div');
  el.className = `pointer-events-auto flex w-80 items-start gap-3 rounded-xl bg-white/95 backdrop-blur p-3 shadow-xl ring-1 ring-black/5 border-l-4 ${tone.border}`;
  el.style.transition = 'transform .2s ease, opacity .2s ease';
  el.style.transform = 'translateX(8px)';
  el.style.opacity = '0';

  el.innerHTML = `
    <i class="fa-solid ${tone.icon} ${tone.color} mt-0.5 text-lg"></i>
    <div class="text-sm text-gray-800 whitespace-pre-line flex-1">${text}</div>
    <button type="button" aria-label="ปิด" class="text-gray-400 hover:text-gray-700">
      <i class="fa-solid fa-xmark"></i>
    </button>
  `;

  const close = () => {
    el.style.transform = 'translateX(8px)'; el.style.opacity = '0';
    setTimeout(() => el.remove(), 180);
  };
  el.querySelector('button').addEventListener('click', close);

  root.appendChild(el);
  requestAnimationFrame(() => { el.style.transform = 'translateX(0)'; el.style.opacity = '1'; });
  if (timeout > 0) setTimeout(close, timeout);
}

/* ==============================
   HELPERS
================================*/
// เวลาเริ่มต้นช่องรับเครื่องมือ
function setNowToReceiveDateTime(){
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
    .toISOString().slice(0,16);
  document.getElementById('receiveDateTime').value = local;
}

// <input type="date"> ต้องการ yyyy-MM-dd
function toDateInputValue(val){
  if (!val) return '';
  const s = String(val).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const d = new Date(s);
  if (!isNaN(d)) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  const m2 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m2) return `${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}`;
  return '';
}

// ดึงค่าจาก Select + อื่นๆ
function getToolTypeValue(selectId = 'toolTypeSelect', otherId = 'toolTypeOther') {
  const sel = document.getElementById(selectId);
  const other = document.getElementById(otherId);
  if (!sel) return '';
  const v = sel.value;
  if (v === 'อื่นๆ') {
    const txt = (other?.value || '').trim();
    return txt || 'อื่นๆ';
  }
  return v;
}

// ดึง fileId จากหลายรูปแบบลิงก์ Google Drive
function extractDriveId(url){
  url = (url || '').trim();
  if (!url) return null;
  let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (m) return m[1];
  m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);       if (m) return m[1];
  return null;
}
// URL สำหรับฝังใน <img>
function driveEmbedUrl(url){
  const id = extractDriveId(url); if (!id) return (url || '').trim();
  return `https://drive.google.com/uc?export=view&id=${id}`;
}
// URL สำรอง (thumbnail)
function driveThumbUrl(url){
  const id = extractDriveId(url); if (!id) return (url || '').trim();
  return `https://drive.google.com/thumbnail?id=${id}&sz=w2000`;
}
    
// แปลงวันที่แบบปลอดภัย -> ไทย
function formatDateTH(s){
  if (!s) return '-';
  const d = new Date(s);                 // รองรับ 'YYYY-MM-DD' และ 'YYYY-MM-DDTHH:mm'
  if (isNaN(d)) return String(s);        // ถ้า parse ไม่ได้ ให้โชว์สตริงเดิม
  return d.toLocaleDateString('th-TH', {
    day: '2-digit', month: '2-digit', year: 'numeric'
  });
}
function formatDateTimeTH(s){
  if (!s) return '-';
  const d = new Date(s);
  if (isNaN(d)) return String(s);
  return d.toLocaleString('th-TH', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit', hour12: false
  });
}
// แปลงค่าวัน/เวลาเป็น epoch (มิลลิวินาที) เพื่อใช้เรียง
function toEpoch(val){
  if (!val) return 0;
  const d = new Date(val);
  return isNaN(d) ? 0 : d.getTime();
}
// เอาคีย์เรียงหลัก: วันที่รับเครื่องมือ (ถ้าไม่มี ใช้วันที่ผ่าตัด)
function getSortEpoch(row){
  return toEpoch(row.receiveDateTime) || toEpoch(row.surgeryDate) || 0;
}
// แปลงเป็น ISO แบบ "YYYY-MM-DD" เฉพาะวันที่
function dateOnlyISO(val){
  if (!val) return '';
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val; // already ISO date
  // รองรับ dd/MM/yyyy
  if (typeof val === 'string'){
    const m = val.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
  }
  const d = new Date(val);
  return isNaN(d) ? '' : d.toISOString().slice(0,10);
}

// เวลาสำหรับใช้เรียง (มิลลิวินาที)
function toEpoch(val){
  if (!val) return 0;
  const d = new Date(val);
  return isNaN(d) ? 0 : d.getTime();
}

function getGroupKeyISO(row){
  return dateOnlyISO(row.surgeryDate) || dateOnlyISO(row.receiveDateTime) || '';
}

// ข้อความหัวข้อวัน (ไทย)
function formatGroupTitle(keyISO){
  if (!keyISO) return 'ไม่ระบุวันที่';
  return formatDateTH(keyISO); // ใช้ helper formatDateTH ที่คุณมีอยู่แล้ว
}


/* ==============================
   API (form-urlencoded)
================================*/
async function callApi(payload) {
  const form = new URLSearchParams();
  form.append("payload", JSON.stringify(payload));

  const res = await fetch(API_BASE, { method: "POST", body: form });
  const text = await res.text(); // debug
  console.log("API status:", res.status, "body:", text);

  if (!res.ok) throw new Error(`HTTP ${res.status} - ${text.slice(0,200)}`);
  try { return JSON.parse(text); }
  catch(e){ throw new Error("Invalid JSON from API: " + text.slice(0,300)); }
}

/* ==============================
   INIT
================================*/
document.addEventListener('DOMContentLoaded', async () => {
  setNowToReceiveDateTime();

  // toggle ช่อง "อื่นๆ" (เพิ่ม)
  document.getElementById('toolTypeSelect').addEventListener('change', function(){
    const show = this.value === 'อื่นๆ';
    document.getElementById('toolTypeOther').classList.toggle('hidden', !show);
    if (!show) document.getElementById('toolTypeOther').value = '';
  });
  // toggle ช่อง "อื่นๆ" (แก้ไข)
  document.getElementById('editToolTypeSelect').addEventListener('change', function(){
    const show = this.value === 'อื่นๆ';
    document.getElementById('editToolTypeOther').classList.toggle('hidden', !show);
    if (!show) document.getElementById('editToolTypeOther').value = '';
  });

  // preview รูปตอนเพิ่ม
  document.getElementById('toolImage').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) { currentPreviewDataURL = null; return; }
    const rd = new FileReader();
    rd.onload = ev => {
      currentPreviewDataURL = ev.target.result;
      document.getElementById('previewImg').src = currentPreviewDataURL;
      document.getElementById('imagePreview').classList.remove('hidden');
    };
    rd.readAsDataURL(file);
  });

  // preview รูปตอนแก้ไข
  document.getElementById('editImageInput').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    const rd = new FileReader();
    rd.onload = ev => {
      editNewImageDataURL = ev.target.result;
      document.getElementById('editPreviewImg').src = editNewImageDataURL;
      document.getElementById('editImagePreview').classList.remove('hidden');
    };
    rd.readAsDataURL(f);
  });
  document.getElementById('btnClearEditImage').addEventListener('click', ()=>{
    editNewImageDataURL = null;
    document.getElementById('editImageInput').value = '';
    document.getElementById('editImagePreview').classList.add('hidden');
  });

  // เปิดรูปใน modal จากปุ่มในตาราง
  document.getElementById('dataTableBody').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="view-image"]');
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const raw = (((medicalTools[idx] || {}).imageUrl) || '').toString().trim();
    openImageModal(raw);
  });
  // ปิด modal รูป (คลิกพื้นหลัง)
  document.getElementById('imageModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeImageModal();
  });
  // ปิด modal แก้ไข (คลิกพื้นหลัง)
  document.getElementById('editModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeEditModal();
  });

  // คิว pending: ลบรายการ
  document.getElementById('pendingBody')?.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-remove]');
    if (!btn) return;
    const i = Number(btn.dataset.remove);
    pendingSets.splice(i, 1);
    renderPending();
  });
  // ปุ่มเพิ่มชุด
  document.getElementById('btnAddSet').addEventListener('click', onAddSet);
  // ปุ่มล้างฟอร์มชุดนี้
  document.getElementById('btnResetCurrent').addEventListener('click', onResetCurrentSet);
  // ปุ่มบันทึกทั้งหมด
  document.getElementById('btnSaveAll').addEventListener('click', onSaveAll);

  // submit แก้ไข
  document.getElementById('editForm').addEventListener('submit', onEditSubmit);

  // ping & โหลดข้อมูล
  try {
    console.log("ping:", await callApi({ action: "ping" }));
    await loadData();
  } catch (err) {
    notify('error', "API มีปัญหา:\n" + err.message + "\nโปรดตรวจ URL / สิทธิ์ของ Web App", {timeout: 5000});
  }
});

/* ==============================
   LOAD & TABLE
================================*/
async function loadData() {
  const json = await callApi({ action: "list" });
  if (!json.success) throw new Error(json.message || "list failed");
  medicalTools = json.data || [];
  updateTable();
}

function updateTable() {
  const tbody = document.getElementById('dataTableBody');
  const recordCount = document.getElementById('recordCount');

  if (!Array.isArray(medicalTools) || medicalTools.length === 0) {
    tbody.innerHTML = `
      <tr id="noDataRow">
        <td colspan="11" class="px-4 py-8 text-center text-gray-500">
          <i class="fas fa-inbox text-4xl mb-2 block"></i>ยังไม่มีข้อมูล
        </td>
      </tr>`;
    recordCount.textContent = '0 รายการ';
    return;
  }

  // ✅ เรียงกลุ่มวัน: ใหม่ → เก่า
  //   ถ้าวันเดียวกัน เรียงตามเวลา (receiveDateTime > surgeryDate) ใหม่ → เก่า
  const data = [...medicalTools].sort((a, b) => {
    const ga = getGroupKeyISO(a);
    const gb = getGroupKeyISO(b);
    if (ga !== gb) return ga < gb ? 1 : -1; // วันใหม่มาก่อน
    const ta = toEpoch(a.receiveDateTime) || toEpoch(a.surgeryDate);
    const tb = toEpoch(b.receiveDateTime) || toEpoch(b.surgeryDate);
    return tb - ta; // เวลาใหม่มาก่อน
  });

  recordCount.textContent = `${data.length} รายการ`;
  tbody.innerHTML = '';

  let currentGroup = '';
  let seqInGroup = 0;

  data.forEach((tool) => {
    const groupKey = getGroupKeyISO(tool);

    // แทรกหัวข้อ "วันที่ ..." เมื่อเปลี่ยนวัน
    if (groupKey !== currentGroup) {
      currentGroup = groupKey;
      seqInGroup = 0;
      const heading = document.createElement('tr');
      heading.className = 'bg-indigo-50';
      heading.innerHTML = `
        <td colspan="11" class="px-4 py-2 text-sm font-semibold text-gray-700">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7V3m8 4V3M5 8h14M5 21h14a2 2 0 002-2V8H3v11a2 2 0 002 2z"></path>
            </svg>
            <span>วันที่: ${formatGroupTitle(groupKey)}</span>
          </div>
        </td>`;
      tbody.appendChild(heading);
    }

    seqInGroup += 1; // ลำดับภายในวัน

    const companyName = (tool.companyName || '').trim();
    const toolType    = (tool.toolType || '').trim();
    const quantity    = tool.quantity ?? '';
    const surgeon     = (tool.surgeon || '').trim();
    const receiver    = (tool.receiver || '').trim();
    const statusText  = (tool.sterileStatus || '').trim();
    const statusClass = statusText === 'Sterile มาแล้ว'
      ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
    const hasImage    = !!(tool.imageUrl && String(tool.imageUrl).trim());

    const receiveText = formatDateTimeTH(tool.receiveDateTime);
    const surgeryText = formatDateTH(tool.surgeryDate);

    // index จริงใน medicalTools (ใช้กับปุ่มดูรูป/แก้ไข/ลบ)
    const realIndex = medicalTools.indexOf(tool);

    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    row.innerHTML = `
      <td class="px-4 py-3 text-sm">${seqInGroup}</td>
      <td class="px-4 py-3 text-sm">${companyName}</td>
      <td class="px-4 py-3 text-sm">${toolType}</td>
      <td class="px-4 py-3 text-sm">${quantity}</td>
      <td class="px-4 py-3 text-sm">
        <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
      </td>
      <td class="px-4 py-3 text-sm">${surgeon}</td>
      <td class="px-4 py-3 text-sm">${receiver || '-'}</td>
      <td class="px-4 py-3 text-sm whitespace-nowrap">${receiveText}</td>
      <td class="px-4 py-3 text-sm whitespace-nowrap">${surgeryText}</td>
      <td class="px-4 py-3 text-sm">
        ${hasImage
          ? `<button type="button" class="text-blue-600 hover:text-blue-800"
                     data-action="view-image" data-idx="${realIndex}">
               <i class="fas fa-image"></i> ดูรูป
             </button>`
          : 'ไม่มีรูป'}
      </td>
      <td class="px-4 py-3 text-sm">
        <div class="flex gap-2">
          <button onclick="editTool(${realIndex})" class="text-blue-600 hover:text-blue-800" title="แก้ไข"><i class="fas fa-edit"></i></button>
          <button onclick="deleteTool(${realIndex})" class="text-red-600 hover:text-red-800" title="ลบ"><i class="fas fa-trash"></i></button>
        </div>
      </td>`;
    tbody.appendChild(row);
  });
}

/* ==============================
   IMAGE MODAL
================================*/
function openImageModal(rawUrl){
  const modal = document.getElementById('imageModal');
  const img   = document.getElementById('modalImage');

  modal.classList.remove('hidden');
  img.src = '';
  img.alt = 'กำลังโหลดรูป...';
  img.style.opacity = '0.25';
  img.referrerPolicy = 'no-referrer';

  if (!rawUrl) {
    img.alt = 'ไม่พบ URL ของรูปภาพ';
    img.style.opacity = '1';
    console.warn('openImageModal: empty URL');
    return;
  }

  const primary  = driveEmbedUrl(rawUrl);
  const fallback = driveThumbUrl(rawUrl);
  let usedFallback = false;

  const setSrc = (u) => {
    const bust = (u.includes('?') ? '&' : '?') + 't=' + Date.now();
    img.src = u + bust;
  };

  img.onload = () => {
    console.log('modalImage onload ✓', usedFallback ? '(fallback)' : '(primary)');
    img.alt = '';
    img.style.opacity = '1';
  };
  img.onerror = () => {
    if (!usedFallback) {
      console.warn('primary image failed, try fallback thumbnail');
      usedFallback = true;
      setSrc(fallback);
    } else {
      console.error('fallback image failed too');
      img.src = '';
      img.alt = 'ไม่สามารถแสดงรูปได้ (สิทธิ์ไฟล์/ลิงก์ผิด หรือไม่ใช่ไฟล์รูป)';
      img.style.opacity = '1';
    }
  };

  console.log('openImageModal URL(primary):', primary);
  setSrc(primary);
}
function closeImageModal(){ document.getElementById('imageModal').classList.add('hidden'); }

/* ==============================
   EDIT FLOW
================================*/
function editTool(index) {
  editingIndex = index;
  const tool = medicalTools[index];

  document.getElementById('editIndex').value = index;
  document.getElementById('editCompanyName').value = tool.companyName || '';

  // ตั้งค่า "ประเภทเครื่องมือ" ใน Select + อื่นๆ
  (function setEditToolType(val){
    const sel = document.getElementById('editToolTypeSelect');
    const other = document.getElementById('editToolTypeOther');
    const options = [
      'Plate and Screw','Nail','เครื่องมือผ่าตัดเปลี่ยนข้อเข่า/ข้อสะโพก',
      'เครื่องมือ Scope','เอกสาร','อื่นๆ'
    ];
    const found = options.includes(val);
    sel.value = found ? val : 'อื่นๆ';
    other.classList.toggle('hidden', found);
    other.value = found ? '' : (val || '');
  })(tool.toolType || '');

  document.getElementById('editQuantity').value = tool.quantity ?? 1;
  document.getElementById('editSterileStatus').value = tool.sterileStatus || 'ต้องทำ Sterile';
  document.getElementById('editSurgeon').value = tool.surgeon || '';
  document.getElementById('editSurgeryDate').value = toDateInputValue(tool.surgeryDate);
  document.getElementById('editReceiver').value = tool.receiver || '';

  // รูปปัจจุบัน + รีเซ็ตตัวเลือกใหม่
  const cur = (tool.imageUrl || '').trim();
  document.getElementById('editImageCurrent').innerHTML = cur
    ? `<span class="text-gray-700">รูปปัจจุบัน:</span> <a href="${cur}" target="_blank" class="underline text-blue-600">เปิดดู</a>`
    : `<span class="text-gray-500">ยังไม่มีรูป</span>`;
  editNewImageDataURL = null;
  document.getElementById('editImageInput').value = '';
  document.getElementById('editImagePreview').classList.add('hidden');

  document.getElementById('editModal').classList.remove('hidden');
}
function closeEditModal(){ document.getElementById('editModal').classList.add('hidden'); editingIndex = -1; }

async function onEditSubmit(e){
  e.preventDefault();

  const idx = parseInt(document.getElementById('editIndex').value, 10);
  const row = medicalTools[idx];
  if (!row || !row.id) { notify('error','ไม่พบข้อมูลรายการที่จะอัปเดต'); return; }

  // ตรวจ "อื่นๆ" ใน modal
  if (document.getElementById('editToolTypeSelect').value === 'อื่นๆ' &&
      !document.getElementById('editToolTypeOther').value.trim()){
    notify('warning','กรุณาระบุประเภทเครื่องมือ (อื่นๆ)'); 
    return;
  }

  // ป้องกันกดซ้ำ + เปิด Saving
  const submitBtn = document.querySelector('#editForm button[type="submit"]');
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-60','cursor-not-allowed');
  }
  openSaving();

  try {
    const json = await callApi({
      action: 'update',
      id: row.id,
      record: {
        companyName: document.getElementById('editCompanyName').value.trim(),
        toolType: getToolTypeValue('editToolTypeSelect','editToolTypeOther'),
        quantity: Number(document.getElementById('editQuantity').value || '0'),
        sterileStatus: document.getElementById('editSterileStatus').value,
        surgeon: document.getElementById('editSurgeon').value.trim(),
        surgeryDate: document.getElementById('editSurgeryDate').value || toDateInputValue(row.surgeryDate),
        receiveDateTime: row.receiveDateTime,
        receiver: document.getElementById('editReceiver').value.trim()
      },
      image: editNewImageDataURL || null
    });

    if (!json.success) throw new Error(json.message || "update failed");

    closeSaving();
    openResult('success','บันทึกการแก้ไขเรียบร้อยแล้ว');

    editNewImageDataURL = null;
    closeEditModal();
    await loadData();

  } catch (err) {
    closeSaving();
    openResult('error','บันทึกไม่สำเร็จ: ' + err.message);
  } finally {
    if (submitBtn){
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-60','cursor-not-allowed');
    }
  }
}


async function deleteTool(index){
  const row = medicalTools[index];
  if (!row || !row.id) { notify('error','ไม่พบข้อมูลรายการที่จะลบ'); return; }
  if (!confirm('คุณต้องการลบข้อมูลนี้หรือไม่?')) return;
  const json = await callApi({ action: 'delete', id: row.id });
  if (!json.success) throw new Error(json.message || "delete failed");
  notify('success','ลบข้อมูลเรียบร้อยแล้ว');
  await loadData();
}

/* ==============================
   PENDING QUEUE (หลายชุด)
================================*/
function getCurrentSetFromForm() {
  return {
    companyName: document.getElementById('companyName').value.trim(),
    toolType: getToolTypeValue('toolTypeSelect','toolTypeOther'),
    quantity: Number(document.getElementById('quantity').value || '0'),
    sterileStatus: document.getElementById('sterileStatus').value,
    surgeon: document.getElementById('surgeon').value.trim(),
    surgeryDate: document.getElementById('surgeryDate').value,
    receiveDateTime: document.getElementById('receiveDateTime').value,
    imageDataURL: currentPreviewDataURL || null
  };
}
function validateOneSet(set) {
  if (!set.companyName) return 'กรุณากรอกชื่อบริษัท';
  if (!set.toolType) return 'กรุณาเลือก/กรอกประเภทเครื่องมือ';
  if (!set.quantity || set.quantity < 1) return 'จำนวนต้องมากกว่า 0';
  if (!set.sterileStatus) return 'กรุณาเลือกสถานะเครื่องมือ';
  if (!set.surgeon) return 'กรุณากรอกแพทย์ผ่าตัด';
  if (!set.surgeryDate) return 'กรุณาเลือกวันที่ผ่าตัด';
  if (!set.receiveDateTime) return 'กรุณาเลือกวันเวลารับเครื่องมือ';
  return null;
}
function renderPending() {
  const cnt = document.getElementById('pendingCount');
  const empty = document.getElementById('pendingEmpty');
  const list = document.getElementById('pendingList');
  const body = document.getElementById('pendingBody');

  cnt.textContent = `${pendingSets.length} ชุด`;
  if (!pendingSets.length) {
    empty.classList.remove('hidden'); list.classList.add('hidden'); body.innerHTML = '';
    return;
  }
  empty.classList.add('hidden'); list.classList.remove('hidden'); body.innerHTML = '';

  pendingSets.forEach((s, i) => {
    const tr = document.createElement('tr');
    const sd = s.surgeryDate ? new Date(s.surgeryDate).toLocaleDateString('th-TH') : '-';
    tr.innerHTML = `
      <td class="px-4 py-2 text-sm">${i+1}</td>
      <td class="px-4 py-2 text-sm">${s.companyName}</td>
      <td class="px-4 py-2 text-sm">${s.toolType}</td>
      <td class="px-4 py-2 text-sm">${s.quantity}</td>
      <td class="px-4 py-2 text-sm">${s.sterileStatus}</td>
      <td class="px-4 py-2 text-sm">${s.surgeon}</td>
      <td class="px-4 py-2 text-sm">${sd}</td>
      <td class="px-4 py-2 text-sm">
        ${s.imageDataURL ? '<span class="text-green-700">มีรูป</span>' : '<span class="text-gray-500">ไม่มีรูป</span>'}
      </td>
      <td class="px-4 py-2 text-sm">
        <button type="button" class="text-red-600 hover:text-red-800" data-remove="${i}">
          <i class="fas fa-trash"></i>
        </button>
      </td>`;
    body.appendChild(tr);
  });
}
function onAddSet(){
  // ถ้าเลือก "อื่นๆ" แต่ไม่พิมพ์ ให้เตือน
  if (document.getElementById('toolTypeSelect').value === 'อื่นๆ' &&
      !document.getElementById('toolTypeOther').value.trim()){
    notify('warning','กรุณาระบุประเภทเครื่องมือในช่อง "อื่นๆ"'); return;
  }
  const set = getCurrentSetFromForm();
  const err = validateOneSet(set);
  if (err) { notify('warning', err); return; }

  pendingSets.push(set);
  renderPending();

  // เคลียร์เฉพาะชุดนี้ (เก็บวัน/เวลาเดิมไว้)
  document.getElementById('companyName').value = '';
  document.getElementById('toolTypeSelect').value = '';
  document.getElementById('toolTypeOther').value = '';
  document.getElementById('toolTypeOther').classList.add('hidden');
  document.getElementById('quantity').value = '';
  document.getElementById('sterileStatus').value = '';
  document.getElementById('surgeon').value = '';

  currentPreviewDataURL = null;
  document.getElementById('toolImage').value = '';
  document.getElementById('imagePreview').classList.add('hidden');

  notify('success', 'เพิ่มชุดเครื่องมือเข้าคิวแล้ว');
  document.getElementById('companyName').focus();
}
function onResetCurrentSet(){
  document.getElementById('medicalToolForm').reset();
  document.getElementById('toolTypeOther').classList.add('hidden');
  document.getElementById('imagePreview').classList.add('hidden');
  currentPreviewDataURL = null;
  setNowToReceiveDateTime();
  notify('info', 'ล้างฟอร์มชุดนี้แล้ว');
}
async function onSaveAll(){
  if (!pendingSets.length) { notify('warning','ยังไม่มีชุดในคิว'); return; }
  const receiver = (document.getElementById('receiverFinal').value || '').trim();
  if (!receiver) { notify('warning','กรุณากรอกชื่อผู้รับเครื่องมือ'); return; }
  if (!confirm(`ยืนยันบันทึกทั้งหมด ${pendingSets.length} ชุด ?`)) return;

  // ป้องกันกดซ้ำ + เปิด Saving Modal
  const btn = document.getElementById('btnSaveAll');
  btn.disabled = true;
  btn.classList.add('opacity-60','cursor-not-allowed');
  openSaving();

  const totalToSave = pendingSets.length;

  try {
    for (const s of pendingSets) {
      const payload = {
        action: 'create',
        record: {
          companyName: s.companyName,
          toolType: s.toolType,
          quantity: s.quantity,
          sterileStatus: s.sterileStatus,
          surgeon: s.surgeon,
          surgeryDate: s.surgeryDate,
          receiveDateTime: s.receiveDateTime,
          receiver: receiver
        },
        image: s.imageDataURL || null
      };
      const res = await callApi(payload);
      if (!res.success) throw new Error(res.message || 'create failed');
    }

    // ปิด Saving + แจ้งผลสำเร็จด้วย Result Modal
    closeSaving();
    openResult('success', `บันทึกรับเครื่องมือสำเร็จ ${totalToSave} ชุด`);

    // เคลียร์คิวและรีเฟรช
    pendingSets = [];
    renderPending();
    document.getElementById('receiverFinal').value = '';
    await loadData();

  } catch (err) {
    // ปิด Saving + แจ้งผลล้มเหลวด้วย Result Modal
    closeSaving();
    openResult('error', 'บันทึกไม่สำเร็จ: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.classList.remove('opacity-60','cursor-not-allowed');
  }
}


// ====== Modal: Saving / Result ======
function openSaving(){
  document.getElementById('savingModal').classList.remove('hidden');
}
function closeSaving(){
  document.getElementById('savingModal').classList.add('hidden');
}

function openResult(type='success', text='บันทึกสำเร็จ'){
  const modal = document.getElementById('resultModal');
  const iconBox = document.getElementById('resultIcon');
  const titleEl = document.getElementById('resultTitle');
  const textEl  = document.getElementById('resultText');

  // icon + สีตามผลลัพธ์
  if (type === 'success'){
    iconBox.className = 'mx-auto mb-3 w-12 h-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center';
    iconBox.innerHTML = '<i class="fas fa-check text-xl"></i>';
    titleEl.textContent = 'บันทึกเรียบร้อย';
  } else {
    iconBox.className = 'mx-auto mb-3 w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center';
    iconBox.innerHTML = '<i class="fas fa-times text-xl"></i>';
    titleEl.textContent = 'บันทึกไม่สำเร็จ';
  }
  textEl.textContent = text || '';

  modal.classList.remove('hidden');

  // ปิดด้วยปุ่ม
  document.getElementById('resultCloseBtn').onclick = () => {
    modal.classList.add('hidden');
  };
  // ปิดเมื่อคลิกฉากหลัง
  modal.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); };
}

</script>


</html>
